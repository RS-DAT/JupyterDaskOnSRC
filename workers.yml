---
- name: Scan for SSH host keys.
  delegate_to: localhost
  shell:
    cmd: ssh-keyscan {{ inventory_hostname }}
  register: ssh_scan

- name: Write the new host keys to known hosts
  delegate_to: localhost
  known_hosts:
    name: "{{ inventory_hostname }}"
    key: "{{ item }}"
  with_items: "{{ ssh_scan.stdout_lines }}"

- name: debug
  debug:
    msg: "Hello from {{ inventory_hostname }} "

- name: Generate SSH keys for worker -> jumphost connections
  openssh_keypair:
    path: "~/.ssh/id_rsa"
    type: rsa
    size: 4096
    state: present
    force: no

- name: Copy SSH keys from workers to jumphost
  fetch:
    src: "~/.ssh/id_rsa.pub"
    dest: "/tmp/id_rsa-{{ inventory_hostname }}.pub"
    flat: yes

- name: Set authorized key for workers
  delegate_to: localhost
  authorized_key:
    user: ubuntu
    state: present
    key: "{{ lookup('file', '/tmp/id_rsa-{{ inventory_hostname }}.pub') }}"



